# iot

## 1.什么是iot？

统一的硬件管理平台，实现非只能设备上云的目标，减少重复建设成本，逐步完善公司业务中台的建设进度；最后希望减少人工维护成本，做大利益最大化

## 2.设计目标

- 搭建IoT PaaS平台，解决各类物联设备接入、数据采集、分发、存储的问题，实现传统硬件设备上云的目标
- 搭建一套可视化的物联设备管理平台，解决租户，厂家，返空汇平台监管设备的需求
- 使用系统代替人工维护，实现设备的监控

## 3.主要模块

- fkh-center-iot：主要提供agent接口，与其它模块进行数据交互，通过sdk进行调用
- fkh-iot-collector：mqtt服务解析模块，对物联网数据进行上报，引入sdk调用fkh-center-iot。提供各各种上报数据的解析方式，目前是mqtt服务数据，后续会提供http以及netty进行数据上报
- fkh-iot-dashboard-api：提供给可视化页面的rest接口
- fkh-iot-dashboard-ui：ui界面
- fkh-iot-disribution：一键部署插件，通过mvn命令，将项目服务部署到服务器上
- fkh-iot-element：通过公共的组件，实体类，工具方法
- fkh-iot-sdk：fkh-center-iot agent接口的接口封装，采用内部封装框架实现流式调用接口，其它服务只需要引入当前模块

## 3.负责模块

- 业务框架的搭建
  - 采用公司内部所封装框架，实现接口代理，方便服务内部自己调用
  - 采用sdk模块，将iot服务接口暴露给其它内部微服务，实现接口的统一管理
  - 公司内部增强mongo\Redis 的引入以及搭建
  - iot中心，统一的依赖管理，依赖包分类
  - Mqtt服务，分布式集群的搭建
- 负责模块（iot-collector）
  - 自定义mqtt数据协议的定义（xxx@xxx@xxx@xxx），数据结构的解析，验证，组装
  - mqtt服务接入，自定义消息消费策略，采用策略模式实现根据不同的消息获取到不同类型的消费策略。后续引入netty等上报数据方式直接实现顶级接口即可
  - 分布式锁的实现，防止多个客户端重复消费mqtt消息
    - 分布式锁组件的抽离，将分布式锁组件制作成注解的方式，提供成公共spring-boot-start
  - 工厂模式实现SPI机制，通过定义顶层接口，可以自动发现项目当中的spi服务，通过不同数据策略上报数据时获取不同的spi服务
- 设备统计
  - 设备上报时对在线设备数量的统计，其中在线设备通过租户来进行统计
    - 在线数量分为整体数量，租户数量，两种数据是需要同一时间进行更改，采用lua脚本实现两个key原子性更新操作，防止两个数据的不一致性
  - 在线设备列表
    - 在线设备记录的实现方式
      - 采用bitmap的方式进行实现：内存占用小，便于管理。但是会存在偏移量一直增长的情况，因为redis中bitmap没有实现内存压缩，就会导致偏移量过大而数据量比较少时占用内存过大的问题
      - 谷歌实现的EWAHCompressedBitmap：对bitmap进行优化，将其存储在long类型的数组中，每一个元素都可以当作一个64位的二进制数，而子集又叫做[Word]，初始化创建4个word，word0只存bitmap头部信息。具体实现：https://mp.weixin.qq.com/s/xxauNrJY9HlVNvLrL5j2hg
      - 直接采用string类型实现

